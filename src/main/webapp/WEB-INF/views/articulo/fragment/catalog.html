<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<body>
	<!-- Command Bar -->
	<div th:fragment="commandBar" id="commandBar" role="group" class="btn-group commandbar-floating">
		
		<!-- Add Split button -->
		<div class="btn-group dropup">
			<button type="button" class="btn btn-success toolbar-button" id="newProduct" th:title="#{prod.add.tooltip}">
				<i class="fa fa-lg fa-plus"/>
			</button>
			<button type="button" class="btn btn-success dropdown-toggle toolbar-caret-button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span class="caret"/> 
				<span class="sr-only"/>
			</button>
			<ul class="dropdown-menu">
				<li><a id="addCategory" th:text="#{control.category}" >Rubro</a></li>
				<li><a id="addClass" th:text="#{control.clazz}">Clase</a></li>
				<li><a id="addType" th:text="#{control.type}">Tipo</a></li>
				<li role="separator" class="divider"></li>
				<li><a id="addBrand" th:text="#{control.brand}">Marca</a></li>
			</ul>
		</div>

		<!-- Edit Single button -->
		<div class="btn-group dropup">
			<button type="button" class="btn btn-warning toolbar-button dropdown-toggle" id="edit" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<i class="fa fa-lg fa-edit"/>
			</button>
			<ul class="dropdown-menu dropdown-menu-right" >
				<li><a id="editCategory" th:text="#{control.category}">Rubro</a></li>
				<li><a id="editClass" th:text="#{control.clazz}">Clase</a></li>
				<li><a id="editType" th:text="#{control.type}">Tipo</a></li>
				<li role="separator" class="divider"></li>
				<li><a id="editBrand" th:text="#{control.brand}">Marca</a></li>
			</ul>
		</div>

		<!-- Delete Single button -->
		<div class="btn-group dropup">
			<button type="button" class="btn btn-danger toolbar-button dropdown-toggle" id="delete" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<i class="fa fa-lg fa-remove"/>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a id="deleteCategory" th:text="#{control.category}">Rubro</a></li>
				<li><a id="deleteClass" th:text="#{control.clazz}">Clase</a></li>
				<li><a id="deleteType" th:text="#{control.type}">Tipo</a></li>
				<li role="separator" class="divider"></li>
				<li><a id="deleteBrand" th:text="#{control.brand}">Marca</a></li>
			</ul>
		</div>
	</div>
	
    <!-- Modal de edicion maestros de articulo -->
	<div th:fragment="catalogEditor">
		<div class="modal fade" id="categoryModalPopup" tabindex="-1" role="dialog" aria-hidden="true" >
			<div class="modal-dialog">
				<div class="color-line" />
				<div class="modal-content">
					<div class="modal-header">
	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
	                    <div class="modal-title">
	                        <span id="catmpTitle"/>
	                    </div>
	                </div>
					<form id="catmpForm" class="form-horizontal" method="post">
						<div class="modal-body">
							<div class="row">
								<div class="col-md-1" />
								<div class="col-md-10" >
									<div class="form-group">
										<label id="catmpCatSelectLabel" for="catmpCatSelect" class="control-label" th:text="#{control.category}" />
	                                    <select id="catmpCatSelect" class="form-control input-md" required="required" autofocus="autofocus" >
	                                        <option value="" th:text="#{control.choose}"/>
	                                        <option th:each="rubro : ${rubros}" th:text="${rubro.nombre}" th:value="${rubro.codigo}" />
	                                    </select>
									</div>
									<div class="form-group">
										<label for="catmpName" class="control-label" th:text="#{control.name}" >Nombre</label>
										<input id="catmpName" class="form-control" type="text" required="required" maxlength="50"/>
									</div>
									<div class="form-group">
										<label for="catmpDesc" class="control-label" th:text="#{control.description}">Descripción</label>
										<input id="catmpDesc" class="form-control" type="text" maxlength="100" />
									</div>
								</div>
								<div class="col-md-1" />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{control.close}" />
							<button id="catmpSave" type="submit" class="btn btn-primary" />
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="modal fade" id="brandModalPopup" tabindex="-1" role="dialog" aria-hidden="true" >
			<div class="modal-dialog">
				<div class="color-line" />
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<div class="modal-title">
							<span id="branmpTitle"/>
						</div>
					</div>
					<form id="branmpForm" class="form-horizontal" method="post">
						<div class="modal-body">
							<div class="row">
								<div class="col-md-1" />
								<div class="col-md-10" >
									<div class="form-group">
										<label id="branmpBranSelectLabel" for="branmpBranSelect" class="control-label" th:text="#{control.brand}" />
										<select id="branmpBranSelect" class="form-control input-md" required="required" autofocus="autofocus" >
											<option value="" th:text="#{control.choose}"/>
											<option th:each="marca : ${marcas}" th:text="${marca.nombre}" th:value="${marca.codigo}" />
										</select>
									</div>
									<div class="form-group">
										<label for="branmpName" class="control-label" th:text="#{control.name}" >Nombre</label>
										<input id="branmpName" class="form-control" type="text" required="required" maxlength="50"/>
									</div>
									<div class="form-group">
										<label for="branmpDesc" class="control-label" th:text="#{control.description}">Descripción</label>
										<input id="branmpDesc" class="form-control" type="text" maxlength="100" />
									</div>
								</div>
								<div class="col-md-1" />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{control.close}" />
							<button id="branmpSave" type="submit" class="btn btn-primary" />
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="modal fade" id="classModalPopup" tabindex="-1" role="dialog" aria-hidden="true" >
			<div class="modal-dialog">
				<div class="color-line" />
				<div class="modal-content">
					<div class="modal-header">
	                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                        <span aria-hidden="true">&times;</span>
	                    </button>
	                    <div class="modal-title">
	                        <span id="clmpTitle"/>
	                    </div>
	                </div>
					<form id="clmpForm" class="form-horizontal" method="post">
						<div class="modal-body">
							<div class="row">
								<div class="col-md-1" />
								<div class="col-md-10" >
									<div class="form-group">
										<label id="clmpCatSelectLabel" for="clmpCatSelect" class="control-label" th:text="#{control.category}" />
	                                    <select id="clmpCatSelect" class="form-control input-md" required="required" autofocus="autofocus" >
	                                        <option value="" th:text="#{control.choose}"/>
	                                        <option th:each="rubro : ${rubros}" th:text="${rubro.nombre}" th:value="${rubro.codigo}" />
	                                    </select>
									</div>
									<div class="form-group">
										<label id="clmpClaSelectLabel" for="clmpClaSelect" class="control-label" th:text="#{control.clazz}" />
	                                    <select id="clmpClaSelect" class="form-control input-md" required="required" autofocus="autofocus" >
	                                        <option value="" th:text="#{control.choose}"/>
	                                    </select>
									</div>
									<div class="form-group">
										<label for="clmpName" class="control-label" th:text="#{control.name}" >Nombre</label>
										<input id="clmpName" class="form-control" type="text" required="required" maxlength="50"/>
									</div>
									<div class="form-group">
										<label for="clmpDesc" class="control-label" th:text="#{control.description}">Descripción</label>
										<input id="clmpDesc" class="form-control" type="text" maxlength="100" />
									</div>
									<div class="form-group">
										<label for="clmpCatInput" class="control-label" th:text="#{control.category}" />
	                                    <select id="clmpCatInput" class="form-control input-md" required="required" >
	                                        <option value="" th:text="#{control.choose}"/>
	                                        <option th:each="rubro : ${rubros}" th:text="${rubro.nombre}" th:value="${rubro.codigo}" />
	                                    </select>
									</div>
								</div>
								<div class="col-md-1" />
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{control.close}" />
							<button id="clmpSave" type="submit" class="btn btn-primary" />
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div th:fragment="catalogScript" >
		<script th:inline="javascript">
			 /*<![CDATA[*/
			$(document).ready(function() {
				initClassForm();
				initCategoryForm();
				initTypeForm();
				initBrandForm();
			})
			
			// Administracion de categoria 
			
			function initCategoryForm() {
				$('#addCategory').click(function() {
					$('#catmpForm').attr('action', 'create')
					cleanCategoryForm();
					setCategoryFormForCreate();
					$('#categoryModalPopup').modal('show');
				});
				$('#deleteCategory').click(function(){
					$('#catmpForm').attr('action', 'delete')
					cleanCategoryForm();
					setCategoryFormForDelete();
					$('#categoryModalPopup').modal('show');
				});
				$('#editCategory').click(function(){
					$('#catmpForm').attr('action', 'edit')
					cleanCategoryForm();
					setCategoryFormForUpdate();
					$('#categoryModalPopup').modal('show');
				});
				$('#catmpCatSelect').change(function(e) {
					if ($('#catmpCatSelect')[0].selectedIndex > 0) {
						loadEntityData($(this).val(), product.rest.categoryByCode, setCategoryData);	
					} else {
						cleanCategoryForm();
					}
				});
				$('#catmpForm').submit(function(e) {
					e.preventDefault();
					var action = $(this).attr('action');
					var actionUrl, actionSuccessMsg, doAction = true;
					switch (action) {
					case 'create':
						actionUrl =	product.rest.addCategory;
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'edit':
						actionUrl =	product.rest.updateCategory; 
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'delete':
						swal({
								title: [[#{control.confirmDelete.title}]],
								text: [[#{prod.category.confirmDelete.message}]] + ' ' + $('#catmpCatSelect option:selected').text(),
								type: 'warning',
								showCancelButton: true,
								confirmButtonColor: '#DD6B55',
								confirmButtonText: [[#{control.confirmDelete}]],
								cancelButtonText: [[#{control.cancelDelete}]]
							}, 
							function (isConfirm) {
								if (isConfirm) {
									saveEntityData(
										getCategoryFormData(), 
										product.rest.deleteCategory, 
										[[#{rest.datasend.success}]],
										updateCategoryCombos
									);
									cleanCategoryForm();
								}
								$('#categoryModalPopup').modal('show');
							}
						);
					default:
						doAction = false;
						break;
					}
					if (doAction) {
						saveEntityData(
							getCategoryFormData(), 
							actionUrl, 
							actionSuccessMsg,
							updateCategoryCombos
						);
					}
					$('#categoryModalPopup').modal('hide');
				});
			}
			
			function updateCategoryCombos () {
				initCombo('#catmpCatSelect', product.rest.getCategories);
				initCombo('#clmpCatSelect', product.rest.getCategories);
				initCombo('#clmpCatInput', product.rest.getCategories);
			} 
			
			function setCategoryFormForCreate () {
				disableCategoryInput(false);
				$('#catmpCatSelectLabel').hide();
				$('#catmpCatSelect').hide();
				$('#catmpCatSelect').prop('disabled', true);
				$('#catmpTitle').text([[#{prod.category.addPopupTitle}]]);
				$('#catmpSave').text([[#{control.save}]]);	
			}

			function setCategoryFormForDelete () {
				disableCategoryInput(true);
				$('#catmpCatSelectLabel').show();
				$('#catmpCatSelect').show();
				$('#catmpCatSelect').prop('disabled', false);
				$('#catmpTitle').text([[#{prod.category.deletePopupTitle}]]);
				$('#catmpSave').text([[#{control.remove}]]);
			}

			function setCategoryFormForUpdate () {
				disableCategoryInput(false);
				$('#catmpCatSelectLabel').show();
				$('#catmpCatSelect').show();
				$('#catmpCatSelect').prop('disabled', false);
				$('#catmpTitle').text([[#{prod.category.editPopupTitle}]]);
				$('#catmpSave').text([[#{control.save}]]);	
			}
			
			function cleanCategoryForm () {
				$('#catmpName').val('');
				$('#catmpDesc').val('');
				$('#catmpCatSelect').val('');	
			}
			
			function disableCategoryInput (value) {
				$('#catmpName').prop('disabled', value);
				$('#catmpDesc').prop('disabled', value);
			}
			
			function getCategoryFormData () {
				var data = {
					codigo : $('#catmpCatSelect').val(),
					nombre : $('#catmpName').val(),
					descripcion : $('#catmpDesc').val()
				};
				return data;
			}
			
			function setCategoryData (data) {
				$('#catmpName').val(data.nombre);
				$('#catmpDesc').val(data.descripcion);
			}
			
			// Administracion de clase
			
			function initClassForm() {
				$('#addClass').click(function() {
					$('#clmpForm').attr('action', 'create')
					cleanClassForm();
					setClassFormForCreate();
					$('#classModalPopup').modal('show');
				});
				$('#deleteClass').click(function(){
					$('#clmpForm').attr('action', 'delete')
					cleanClassForm();
					setClassFormForDelete();
					$('#classModalPopup').modal('show');
				});
				$('#editClass').click(function(){
					$('#clmpForm').attr('action', 'edit')
					cleanClassForm();
					setClassFormForUpdate();
					$('#classModalPopup').modal('show');
				});
				$('#clmpCatSelect').change(function(e) {
					chainCombo('#clmpCatSelect', '#clmpClaSelect', product.rest.classesByCategory);
				});
				$('#clmpClaSelect').change(function(e) {
					if ($('#clmpClaSelect')[0].selectedIndex > 0) {
						loadEntityData($(this).val(), product.rest.classByCode, setClassData);	
					} else {
						cleanClassForm();
					}
				});
				$('#clmpForm').submit(function(e) {
					e.preventDefault();
					var action = $(this).attr('action');
					var actionUrl, actionSuccessMsg, doAction = true;
					switch (action) {
					case 'create':
						actionUrl =	product.rest.addClass;
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'edit':
						actionUrl =	product.rest.updateClass; 
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'delete':
						swal({
								title: [[#{control.confirmDelete.title}]],
								text: [[#{prod.clazz.confirmDelete.message}]] + ' ' + $('#clmpClaSelect option:selected').text(),
								type: 'warning',
								showCancelButton: true,
								confirmButtonColor: '#DD6B55',
								confirmButtonText: [[#{control.confirmDelete}]],
								cancelButtonText: [[#{control.cancelDelete}]]
							}, 
							function (isConfirm) {
								if (isConfirm) {
									saveEntityData(
										getClassFormData(), 
										product.rest.deleteClass, 
										[[#{rest.datasend.success}]],
										function() {initCombo('#clmpClaSelect', product.rest.getClasses)}
									);
									cleanClassForm();
								} 
								$('#classModalPopup').modal('show');
							}
						);
					default:
						doAction = false;
						break;
					}
					if (doAction) {
						saveEntityData(
							getClassFormData(), 
							actionUrl, 
							actionSuccessMsg,
							function() {initCombo('#clmpClaSelect', product.rest.getClasses)}
						);
					}
					$('#classModalPopup').modal('hide');
				});
			}

			function setClassFormForCreate () {
				disableClassInput(false);
				$('#clmpClaSelectLabel').hide();
				$('#clmpClaSelect').hide();
				$('#clmpClaSelect').prop('disabled', true); // Se deshabilita para que no se valide en el formulario
				$('#clmpCatSelectLabel').hide();
				$('#clmpCatSelect').hide();
				$('#clmpCatSelect').prop('disabled', true); // Se deshabilita para que no se valide en el formulario
				$('#clmpTitle').text([[#{prod.clazz.addPopupTitle}]]);
				$('#clmpSave').text([[#{control.save}]]);	
			}

			function setClassFormForDelete () {
				disableClassInput(true);
				$('#clmpClaSelectLabel').show();
				$('#clmpClaSelect').show();
				$('#clmpClaSelect').prop('disabled', false);
				$('#clmpCatSelectLabel').show();
				$('#clmpCatSelect').show();
				$('#clmpCatSelect').prop('disabled', false); // Se deshabilita para que no se valide en el formulario				
				$('#clmpTitle').text([[#{prod.clazz.deletePopupTitle}]]);
				$('#clmpSave').text([[#{control.remove}]]);
			}

			function setClassFormForUpdate () {
				disableClassInput(false);
				$('#clmpClaSelectLabel').show();
				$('#clmpClaSelect').show();
				$('#clmpClaSelect').prop('disabled', false);
				$('#clmpCatSelectLabel').show();
				$('#clmpCatSelect').show();
				$('#clmpCatSelect').prop('disabled', false); // Se deshabilita para que no se valide en el formulario	
				$('#clmpTitle').text([[#{prod.clazz.editPopupTitle}]]);
				$('#clmpSave').text([[#{control.save}]]);	
			}
			
			function cleanClassForm () {
				$('#clmpName').val('');
				$('#clmpDesc').val('');
				$('#clmpCatInput').val('');
				$('#clmpClaSelect').val('');	
				$('#clmpClaSelect').val('');	
			}
			
			function disableClassInput (value) {
				$('#clmpName').prop('disabled', value);
				$('#clmpDesc').prop('disabled', value);
				$('#clmpCatInput').prop('disabled', value);
			}
			
			function getClassFormData () {
				var data = {
					codigo : $('#clmpClaSelect').val(),
					nombre : $('#clmpName').val(),
					descripcion : $('#clmpDesc').val(),
					codRubro :$('#clmpCatInput').val()
				};
				return data;
			}
			
			function setClassData (data) {
				$('#clmpName').val(data.nombre);
				$('#clmpDesc').val(data.descripcion);
				$('#clmpCatInput').val(data.codRubro);
			}

			// Administracion de marca
			
			function initBrandForm() {
				$('#addBrand').click(function() {
					$('#branmpForm').attr('action', 'create')
					cleanBrandForm();
					setBrandFormForCreate();
					$('#brandModalPopup').modal('show');
				});
				$('#deleteBrand').click(function(){
					$('#branmpForm').attr('action', 'delete')
					cleanBrandForm();
					setBrandFormForDelete();
					$('#brandModalPopup').modal('show');
				});
				$('#editBrand').click(function(){
					$('#branmpForm').attr('action', 'edit')
					cleanBrandForm();
					setBrandFormForUpdate();
					$('#brandModalPopup').modal('show');
				});
				$('#branmpBranSelect').change(function(e) {
					if ($('#branmpBranSelect')[0].selectedIndex > 0) {
						loadEntityData($(this).val(), product.rest.brandByCode, setBrandData);	
					} else {
						cleanBrandForm();
					}
				});
				$('#branmpForm').submit(function(e) {
					e.preventDefault();
					var action = $(this).attr('action');
					var actionUrl, actionSuccessMsg, doAction = true;
					switch (action) {
					case 'create':
						actionUrl =	product.rest.addBrand;
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'edit':
						actionUrl =	product.rest.updateBrand; 
						actionSuccessMsg = [[#{rest.datasend.success}]];
						break;
					case 'delete':
						swal({
								title: [[#{control.confirmDelete.title}]],
								text: [[#{prod.brand.confirmDelete.message}]] + ' ' + $('#branmpBranSelect option:selected').text(),
								type: 'warning',
								showCancelButton: true,
								confirmButtonColor: '#DD6B55',
								confirmButtonText: [[#{control.confirmDelete}]],
								cancelButtonText: [[#{control.cancelDelete}]]
							}, 
							function (isConfirm) {
								if (isConfirm) {
									saveEntityData(
										getBrandFormData(), 
										product.rest.deleteBrand, 
										[[#{rest.datasend.success}]],
										updateBrandCombos
									);
									cleanBrandForm();
								}
								$('#brandModalPopup').modal('show');
							}
						);
					default:
						doAction = false;
						break;
					}
					if (doAction) {
						saveEntityData(
							getBrandFormData(), 
							actionUrl, 
							actionSuccessMsg,
							updateBrandCombos
						);
					}
					$('#brandModalPopup').modal('hide');
				});
			}
			
			function updateBrandCombos () {
				initCombo('#branmpBranSelect', product.rest.getBrands);
			} 
			
			function setBrandFormForCreate () {
				disableBrandInput(false);
				$('#branmpBranSelectLabel').hide();
				$('#branmpBranSelect').hide();
				$('#branmpBranSelect').prop('disabled', true);
				$('#branmpTitle').text([[#{prod.brand.addPopupTitle}]]);
				$('#branmpSave').text([[#{control.save}]]);	
			}

			function setBrandFormForDelete () {
				disableBrandInput(true);
				$('#branmpBranSelectLabel').show();
				$('#branmpBranSelect').show();
				$('#branmpBranSelect').prop('disabled', false);
				$('#branmpTitle').text([[#{prod.brand.deletePopupTitle}]]);
				$('#branmpSave').text([[#{control.remove}]]);
			}

			function setBrandFormForUpdate () {
				disableBrandInput(false);
				$('#branmpBranSelectLabel').show();
				$('#branmpBranSelect').show();
				$('#branmpBranSelect').prop('disabled', false);
				$('#branmpTitle').text([[#{prod.brand.editPopupTitle}]]);
				$('#branmpSave').text([[#{control.save}]]);	
			}
			
			function cleanBrandForm () {
				$('#branmpName').val('');
				$('#branmpDesc').val('');
				$('#branmpBranSelect').val('');	
			}
			
			function disableBrandInput (value) {
				$('#branmpName').prop('disabled', value);
				$('#branmpDesc').prop('disabled', value);
			}
			
			function getBrandFormData () {
				var data = {
					codigo : $('#branmpBranSelect').val(),
					nombre : $('#branmpName').val(),
					descripcion : $('#branmpDesc').val()
				};
				return data;
			}
			
			function setBrandData (data) {
				$('#branmpName').val(data.nombre);
				$('#branmpDesc').val(data.descripcion);
			}
			 
			// Administracion de tipo
			
			function initTypeForm() {
				$('#addType').click(function(){
					
				});
				$('#deleteType').click(function(){
					
				});
				$('#editType').click(function(){
					
				});
			}
			
			function loadEntityData(inputData, restUrl, setData) {
				$.ajax({
					type : 'POST',
					url : restUrl,
					dataType: 'json',
					contentType: 'application/json',
					data : inputData,
					success : function(data) {
						setData(data);
					},
					error : function(jqXHR, status) {
						$.notify({
							message: [[#{rest.dataload.error}]]
						},{
							type: 'danger'
						});
					}
				});
			}	

			function saveEntityData(data, restUrl, successMsg, callback) {
				$.ajax({
					type : 'POST',
					url : restUrl,
					dataType: 'json',
					contentType: 'application/json',
					data : JSON.stringify(data),
					success : function() {
						$.notify({
							message: successMsg
						},{
							type: 'success'
						});
						if (callback) {
							callback();
						}
					},
					error : function(jqXHR, status) {
						$.notify({
							message: [[#{rest.datasend.error}]]
						},{
							type: 'danger'
						});
					}
				});
			}
			/*]]>*/
		</script>
	</div>
</body>
</html>