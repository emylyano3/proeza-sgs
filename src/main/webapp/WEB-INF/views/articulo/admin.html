<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorator="layout.html">
<body>
	<div id="content" layout:fragment="contenido">
		<link rel="stylesheet" href="../../../resources/jqx/css/jqx.base.css" th:href="@{/resources/jqx/css/jqx.base.css}" type="text/css" media="screen" />
		<link rel="stylesheet" href="../../../resources/jqx/css/jqx.energyblue.css" th:href="@{/resources/jqx/css/jqx.energyblue.css}" type="text/css" media="screen" />
		<link rel="stylesheet" href="../../../resources/fileinput/css/fileinput.css" th:href="@{/resources/fileinput/css/fileinput.css}" media="all" type="text/css" />

		<div class="row">
			<div class="col-md-12">
				<div class="input-group">
					<input id="filter" type="text" class="form-control" placeholder="Buscar..." th:placeholder="#{control.search-articles}" /> 
					<span class="input-group-btn">
						<button id="eraser" class="btn btn-default" type="button">
							<i class="fa fa-eraser" />
						</button>
					</span>
				</div>
			</div>
		</div>
		<p/>
		<!-- Grilla de articulos -->
		<div class="row">
			<div class="col-md-12">
				<div id="articulos" />
			</div> 
		</div>
		<!-- Modal de edicion -->
		<div class="modal fade" id="editionPopup" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
        				<h4 class="modal-title"><span th:text="#{art.admin.popup.edit}" text="Editar Artículo" /></h4>
      				</div>
					<div id="editpanel" class="modal-body" >
						<form class="form-horizontal" style="width: 500px">
							<div class="form-group">
								<label for="codigo" class="col-sm-2 control-label" th:text="#{control.code}" />
								<div class="col-sm-10">
									<input id="codigo" class="form-control input-sm" disabled="disabled"/>
								</div>
							</div>
							<div class="form-group">
								<label for="modelo" class="col-sm-2 control-label" th:text="#{control.model}" />
								<div class="col-sm-10">
									<input id="modelo" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="descripcion" class="col-sm-2 control-label" th:text="#{control.description}" />
								<div class="col-sm-10">
									<input id="descripcion" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="clase" class="col-sm-2 control-label" th:text="#{control.class}" />
								<div class="col-sm-10">
									<select id="clase" class="form-control input-sm">
										<option />
										<option th:each="clase : ${clases}" th:text="${clase.nombre}" th:id="${clase.codigo}" />
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="tipo" class="col-sm-2 control-label" th:text="#{control.type}" />
								<div class="col-sm-10">
									<select id="tipo" class="form-control input-sm">
										<option />
										<option th:each="tipo : ${tipos}" th:text="${tipo.nombre}" th:id="${tipo.codigo}" />
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="marca" class="col-sm-2 control-label" th:text="#{control.brand}" />
								<div class="col-sm-10">
									<select id="marca" class="form-control input-sm">
										<option />
										<option th:each="marca : ${marcas}" th:text="${marca.nombre}" th:id="${marca.codigo}" />
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="precio" class="col-sm-2 control-label" th:text="#{control.price}" />
								<div class="col-sm-10">
									<input id="precio" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="costo" class="col-sm-2 control-label" th:text="#{control.cost}" />
								<div class="col-sm-10">
									<input id="costo" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="rubro" class="col-sm-2 control-label" th:text="#{control.category}" />
								<div class="col-sm-10">
									<select id="rubro" class="form-control input-sm">
										<option />
										<option th:each="rubro : ${rubros}" th:text="${rubro.nombre}" th:id="${rubro.codigo}" />
									</select>
								</div>
							</div>
							<div class="hidden" >
								<input id="cantidad" class="hidden" />
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button id="cancel" type="button" class="btn btn-default" th:text="#{control.cancel}" data-dismiss="modal"/>
						<button id="save" type="button" class="btn btn-primary" th:text="#{control.save}" data-dismiss="modal"/>
			      	</div>
				</div>
			</div>
		</div>
		<!-- Modal de agregado de imagen -->
		<div class="modal fade" id="addImagePopup" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
        				<h4 class="modal-title">
        					<span th:text="#{art.admin.popup.addImage}" text="Agregar Imagen" />
        				</h4>
      				</div>
					<div id="addImagePanel" class="modal-body" >
				  		<form enctype="multipart/form-data">
							<input id="uploadImage" name="file" type="file" accept="image/*" />
						</form>
					</div>
					<div class="modal-footer">
						<button id="cancel" type="button" class="btn btn-default" th:text="#{control.cancel}" data-dismiss="modal"/>
			      	</div>
				</div>
			</div>
		</div>
		<!-- Menu Contextual -->
		<div id="gridMenu">
	        <ul>
	            <li id="addImgToArt" th:text="#{art.admin.menu.addImage}"/>
	            <li id="editArt" th:text="#{art.admin.menu.edit}"/>
	            <li id="deleteArt" th:text="#{art.admin.menu.delete}"/>
	        </ul>
       </div>
		<script type="text/javascript" src="../../../resources/jqx/js/jqxcore.js" th:src="@{/resources/jqx/js/jqxcore.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxdata.js" th:src="@{/resources/jqx/js/jqxdata.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxbuttons.js" th:src="@{/resources/jqx/js/jqxbuttons.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxscrollbar.js" th:src="@{/resources/jqx/js/jqxscrollbar.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxmenu.js" th:src="@{/resources/jqx/js/jqxmenu.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.js" th:src="@{/resources/jqx/js/jqxgrid.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.selection.js" th:src="@{/resources/jqx/js/jqxgrid.selection.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxnumberinput.js" th:src="@{/resources/jqx/js/jqxnumberinput.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxwindow.js" th:src="@{/resources/jqx/js/jqxwindow.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxlistbox.js" th:src="@{/resources/jqx/js/jqxlistbox.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxdropdownlist.js" th:src="@{/resources/jqx/js/jqxdropdownlist.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxinput.js" th:src="@{/resources/jqx/js/jqxinput.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/demos.js" th:src="@{/resources/jqx/js/demos.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.sort.js" th:src="@{/resources/jqx/js/jqxgrid.sort.js}" />
		<script type="text/javascript" src="../../../resources/jquery/jquery.inputmask.bundle.js" th:src="@{/resources/jquery/jquery.inputmask.bundle.js}" />
		<script type="text/javascript" src="../../../resources/bootstrap/js/bootstrap-notify.js" th:src="@{/resources/bootstrap/js/bootstrap-notify.js}" />
		<script type="text/javascript" src="../../../resources/fileinput/js/fileinput.js" th:src="@{/resources/fileinput/js/fileinput.js}" />
		<script type="text/javascript" src="../../../resources/fileinput/js/fileinput_locale_es.js" th:src="@{/resources/fileinput/js/fileinput_locale_es.js}" />
		<script th:inline="javascript">
			// Inicializacion de la tabla de arículos
			$(document).ready(
				function() {
					// prepare the data
					var source = {
						datatype : "json",
						id : "id",
						url : "/proeza-sgs/rest/articulo/search?filter=",
						dataFields : [ 
						               {name : 'codigo', type : 'string'},
						               {name : 'modelo', type : 'string'},
						               {name : 'descripcion', type : 'string' }, 
						               {name : 'clase', type : 'string'},
						               {name : 'tipo', type : 'string'}, 
						               {name : 'marca', type : 'string'}, 
						               {name : 'rubro', type : 'string'}, 
						               {name : 'precio', type : 'double'}, 
						               {name : 'costo', type : 'double'}, 
						               {name : 'cantidad', type : 'int'}, 
						               {name : 'codClase', type : 'string'}, 
						               {name : 'codTipo', type : 'string'},
						               {name : 'codMarca', type : 'string'}, 
						               {name : 'codRubro', type : 'string'},
						               ],
					updaterow : function(rowid, rowdata, commit) {
						$.ajax({
							type : 'POST',
							url : '/proeza-sgs/rest/articulo/update',
							dataType: 'json',
							contentType: 'application/json',
							data : JSON.stringify(rowdata),
							success : function() {
								$.notify({
									title: /*[[#{art.alert.updaterow.success.title}]]*/ '<strong>Modificación de artículo:</strong>',
									message: /*[[#{art.alert.updaterow.success.message}]]*/ 'La modificación se realizó correctamente'
								},{
									type: 'success'
								});
								commit(true);
							},
							error: function () {            
								$.notify({
									title: /*[[#{art.alert.updaterow.error.title}]]*/ '<strong>Modificación de artículo:</strong>',
									message: /*[[art.alert.updaterow.error.message]]*/ 'Ocurrió un error en la actualización del artículo'
								},{
									type: 'danger'
								});
								commit(false);
					        }
						});
					},
					deleterow : function(rowid, commit) {
						// Hacer aca la logica de sincronizar con el servidor (usando ajax).
						// Enviar datos, comitear con true si la sincronizacion fue exitosa, false si hubo fallo
						commit(true);
					}
				};
				var dataAdapter = new $.jqx.dataAdapter(source);
				var editrow = -1;
				
				// initializa la grilla de articulos
				$("#articulos").jqxGrid({
					width : '100%',
					height : '100%',
					theme : 'energyblue',
					source : dataAdapter,
					pageable : false,
					autoheight : false,
					altrows : true,
					sortable : true,
					enabletooltips : true,
					columns : [ {
						text : /*[[#{art.grid.model}]]*/ 'Modelo',
						dataField : 'modelo',
						width : '30%'
					}, {
						text : /*[[#{art.grid.class}]]*/ 'Clase',
						dataField : 'clase',
						width : '30%'
					}, {
						text : /*[[#{art.grid.trademark}]]*/ 'Marca',
						dataField : 'marca',
						width : '30%'
					}, {
						text : /*[[#{art.grid.price}]]*/ 'Precio',
						dataField : 'precio',
						cellsalign : 'right',
						cellsformat : 'c2',
						minwidth : '10%'
					} ]
				});
				// create context menu
				var contextMenu = $("#gridMenu").jqxMenu({
					width : 180,
					height : 90,
					autoOpenPopup : false,
					mode : 'popup'

				});
				$("#articulos").on('contextmenu', function() {
					return false;
				});

				// handle context menu clicks.
				$("#gridMenu").on('itemclick', function(event) {
					var args = event.args;
					var rowindex = $("#articulos").jqxGrid('getselectedrowindex');
					editrow = rowindex;
					var offset = $("#articulos").offset();
					// get the clicked row's data and initialize the input fields.
					var dataRecord = $("#articulos").jqxGrid('getrowdata', rowindex);
					if ($.trim($(args).text()) == [[#{art.admin.menu.edit}]]) {
						$("#codigo").val(dataRecord.codigo);
						$("#modelo").val(dataRecord.modelo);
						$("#descripcion").val(dataRecord.descripcion);
						$("#clase").val(dataRecord.clase);
						$("#tipo").val(dataRecord.tipo);
						$("#marca").val(dataRecord.marca);
						$("#rubro").val(dataRecord.rubro);
						$("#precio").val(dataRecord.precio);
						$("#costo").val(dataRecord.costo);
						$("#cantidad").val(dataRecord.cantidad);
						$("#editionPopup").modal('show');
					} else if ($.trim($(args).text()) == [[#{art.admin.menu.delete}]]) {
						var rowid = $("#articulos").jqxGrid('getrowid', rowindex);
						$("#articulos").jqxGrid('deleterow', rowid);
					} else if ($.trim($(args).text()) == [[#{art.admin.menu.addImage}]]) {
				         var fileInputOptions = {
								showUpload : true,
								showRemove : true,
				                allowedFileExtensions : ['jpg', 'png','gif'],
								allowedFileTypes : ["image"],
				                uploadUrl: '/proeza-sgs/rest/articulo/addImage?artCode=' + dataRecord.codigo
						};
			         	// File input plugin options
			            $("#uploadImage").fileinput(fileInputOptions);
						$("#addImagePopup").modal('show');
					}
				});
				$("#articulos").on('rowclick', function(event) {	
						if (event.args.rightclick) {	
							$("#articulos").jqxGrid('selectrow', event.args.rowindex);
							var scrollTop = $(window).scrollTop();
							var scrollLeft = $(window).scrollLeft();
							contextMenu.jqxMenu('open', parseInt(event.args.originalEvent.clientX) + 5 + scrollLeft,
									parseInt(event.args.originalEvent.clientY) + 5 + scrollTop);
							return false;
						}
					}
				);

				// update the edited row when the user clicks the 'save' button.
				$("#save").click(function() {
					if (editrow >= 0) {
						var row = {
							codigo : $("#codigo").val(),
							modelo : $("#modelo").val(),
							descripcion : $("#descripcion").val(),
							clase : $("#clase").val(),
							tipo : $("#tipo").val(),
							rubro : $("#rubro").val(),
							marca : $("#marca").val(),
							precio : $("#precio").val(),
							costo : $("#costo").val(),
							cantidad : $("#cantidad").val(),
							codClase : $( "#clase option:selected" ).attr('id'),
							codTipo : $( "#tipo option:selected" ).attr('id'),
							codMarca : $( "#marca option:selected" ).attr('id'),
							codRubro : $( "#rubro option:selected" ).attr('id')
						};
						var rowID = $('#articulos').jqxGrid('getrowid', editrow);
						$('#articulos').jqxGrid('updaterow', rowID, row);
					}
					$("#editionPopup").modal('hide');
				});

				// Hide popup when cancel
				$("#cancel").click(function() {
					$("#editionPopup").modal('hide');
					$("#addImagePopup").modal('hide');
				});

				// Configuracion del control de ingreso del precio
				$("#precio").inputmask("currency", {
					"autoUnmask" : true
				});
				$("#costo").inputmask("currency", {
					"autoUnmask" : true
				});
				
				 // Inicializa los controles del filto
	            $('#filter').on('input', function() {
	                var filter = $(this).val();
	                var params = "filter=" + replaceAll(filter.trim(), ' ',',');
	                source.url = "/proeza-sgs/rest/articulo/search?" + params;
					// pasando "cells" al comando 'updatebounddata' solo se refrescan los valores de las celdas cuando la cantidad nueva de filas es igual a la anterior
	                $("#articulos").jqxGrid('updatebounddata', 'cells');
	            });
	            $("#clear").click(function () {
	                $("#articulos").jqxGrid('clear');
	                $("#filter").val("");
	            });
	            $("#eraser").click(function () {
	                $("#articulos").jqxGrid('clear');
	                $("#filter").val("");
	            });
			});
			
			function replaceAll(text, busca, reemplaza ){
				while (text.toString().indexOf(busca) != -1) {
					text = text.toString().replace(busca,reemplaza);
				}
				return text;
			}
		</script>
	</div>
</body>
</html>
