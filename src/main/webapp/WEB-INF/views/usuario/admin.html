<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout.html">
<body>
	<div id="content" layout:fragment="contenido">
		<link rel="stylesheet" href="../../../resources/jqx/css/jqx.base.css" th:href="@{/resources/jqx/css/jqx.base.css}" type="text/css" media="screen" />
		<link rel="stylesheet" href="../../../resources/jqx/css/jqx.energyblue.css" th:href="@{/resources/jqx/css/jqx.energyblue.css}" type="text/css" media="screen" />
		<link rel="stylesheet" href="../../../resources/app/css/animate.css" th:href="@{/resources/app/css/animate.css}" type="text/css" media="screen" />

		<!-- Grilla de usuarios -->
		<div class="row">
			<div class="col-md-12">
				<div id="usuarios" />
			</div> 
		</div>
		<!-- Modal de edicion -->
		<div class="modal fade" id="editionPopup" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
        				<h4 class="modal-title"><span th:text="#{usu.admin.popup.edit}" text="Editar Usuario" /></h4>
      				</div>
					<div id="editpanel" class="modal-body" >
						<form class="form-horizontal" style="width: 500px">
							<div class="form-group">
								<label for="alias" class="col-sm-2 control-label" th:text="#{control.username}" />
								<div class="col-sm-10">
									<input id="alias" class="form-control input-sm" disabled="disabled"/>
								</div>
							</div>
							<div class="form-group">
								<label for="nombre" class="col-sm-2 control-label" th:text="#{control.name}" />
								<div class="col-sm-10">
									<input id="nombre" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="apellido" class="col-sm-2 control-label" th:text="#{control.lastname}" />
								<div class="col-sm-10">
									<input id="apellido" class="form-control input-sm" />
								</div>
							</div>
							<div class="form-group">
								<label for="email" class="col-sm-2 control-label" th:text="#{control.email}" />
								<div class="col-sm-10">
									<input id="email" class="form-control input-sm" />
								</div>
							</div>							
						</form>
					</div>
					<div class="modal-footer">
						<button id="cancel" type="button" class="btn btn-default" th:text="#{control.cancel}" data-dismiss="modal"/>
						<button id="save" type="button" class="btn btn-primary" th:text="#{control.save}" data-dismiss="modal"/>
			      	</div>
				</div>
			</div>
		</div>
		<!-- Menu Contextual -->
		<div id="gridMenu">
	        <ul>
	            <li id="editUsu" th:text="#{usu.admin.menu.edit}"/>
	            <li id="deleteUsu" th:text="#{usu.admin.menu.delete}"/>
	        </ul>
       </div>
		<script type="text/javascript" src="../../../resources/jqx/js/jqxcore.js" th:src="@{/resources/jqx/js/jqxcore.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxdata.js" th:src="@{/resources/jqx/js/jqxdata.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxbuttons.js" th:src="@{/resources/jqx/js/jqxbuttons.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxscrollbar.js" th:src="@{/resources/jqx/js/jqxscrollbar.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxmenu.js" th:src="@{/resources/jqx/js/jqxmenu.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.js" th:src="@{/resources/jqx/js/jqxgrid.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.selection.js" th:src="@{/resources/jqx/js/jqxgrid.selection.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxnumberinput.js" th:src="@{/resources/jqx/js/jqxnumberinput.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxwindow.js" th:src="@{/resources/jqx/js/jqxwindow.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxlistbox.js" th:src="@{/resources/jqx/js/jqxlistbox.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxdropdownlist.js" th:src="@{/resources/jqx/js/jqxdropdownlist.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxinput.js" th:src="@{/resources/jqx/js/jqxinput.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/demos.js" th:src="@{/resources/jqx/js/demos.js}" />
		<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.sort.js" th:src="@{/resources/jqx/js/jqxgrid.sort.js}" />
		<script type="text/javascript" src="../../../resources/jquery/jquery.inputmask.bundle.js" th:src="@{/resources/jquery/jquery.inputmask.bundle.js}" />
		<script type="text/javascript" src="../../../resources/bootstrap/js/bootstrap-notify.js" th:src="@{/resources/bootstrap/js/bootstrap-notify.js}" />
		
		<script type="text/javascript">
			// Inicializacion de la tabla de arículos
			$(document).ready(
					function() {
						// prepare the data
						var source = {
							datatype : "json",
							id : "id",
							url : "/proeza-sgs/rest/usuario/findAll",
							dataFields: [
				     	                    { name: 'alias', type: 'string' },
				     	                    { name: 'nombre', type: 'string' },
				     	                    { name: 'apellido', type: 'string' },
				     	                    { name: 'email', type: 'string' },
				     	    ],
							updaterow : function(rowid, rowdata, commit) {
								$.ajax({
									type : 'POST',
									url : '/proeza-sgs/rest/usuario/update',
									dataType: 'json',
									contentType: 'application/json',
									data : JSON.stringify(rowdata),
									success : function() {
										$.notify({
											title: '<strong>Modificación de usuario:</strong>',
											message: 'La modificación se realizó correctamente'
										},{
											type: 'success'
										});
										commit(true);
									},
									error: function () {            
										$.notify({
											title: '<strong>Modificación de usuario:</strong>',
											message: 'Ocurrió un error en la actualización del usuario'
										},{
											type: 'danger'
										});
										commit(false);
							        }
								});
							},
							deleterow : function(rowid, commit) {
								// Hacer aca la logica de sincronizar con el servidor (usando ajax).
								// Enviar datos, comitear con true si la sincronizacion fue exitosa, false si hubo fallo
								commit(true);
							}
						};

						var dataAdapter = new $.jqx.dataAdapter(source);
						var editrow = -1;

						// initializa la grilla de usuarios
						$("#usuarios").jqxGrid({
							width : '100%',
							height : '100%',
							theme : 'energyblue',
							source : dataAdapter,
							pageable : false,
							autoheight : false,
							altrows : true,
							sortable : true,
							enabletooltips : true,
							columns : [ {
								text : 'Alias',
								dataField : 'alias',
								width : '20%'
							}, {
								text : 'Nombre',
								dataField : 'nombre',
								width : '20%'
							}, {
								text : 'Apellido',
								dataField : 'apellido',
								width : '20%'
							}, {
								text : 'Mail',
								dataField : 'email',
								width : '30%'
							} ]
						});
						// create context menu
						var contextMenu = $("#gridMenu").jqxMenu({
							width : 180,
							height : 60,
							autoOpenPopup : false,
							mode : 'popup'

						});
						$("#usuarios").on('contextmenu', function() {
							return false;
						});

						// handle context menu clicks.
						$("#gridMenu").on('itemclick', function(event) {
							var args = event.args;
							var rowindex = $("#usuarios").jqxGrid('getselectedrowindex');
							if ($.trim($(args).text()) == "Editar Usuario") {
								// open the popup window when the user clicks a button.
								editrow = rowindex;
								var offset = $("#usuarios").offset();
								// get the clicked row's data and initialize the input fields.
								var dataRecord = $("#usuarios").jqxGrid('getrowdata', editrow);
								$("#alias").val(dataRecord.alias);
								$("#nombre").val(dataRecord.nombre);
								$("#apellido").val(dataRecord.apellido);
								$("#email").val(dataRecord.email);
								$("#editionPopup").modal('show');
							} else if ($.trim($(args).text()) == "Eliminar Usuario") {
								var rowid = $("#usuarios").jqxGrid('getrowid', rowindex);
								$("#usuarios").jqxGrid('deleterow', rowid);
							}
						});
						$("#usuarios").on(
							'rowclick',
							function(event) {	
								if (event.args.rightclick) {	
									$("#usuarios").jqxGrid('selectrow', event.args.rowindex);
									var scrollTop = $(window).scrollTop();
									var scrollLeft = $(window).scrollLeft();
									contextMenu.jqxMenu('open', parseInt(event.args.originalEvent.clientX) + 5 + scrollLeft,
											parseInt(event.args.originalEvent.clientY) + 5 + scrollTop);
									return false;
								}
							}
						);

						// update the edited row when the user clicks the 'save' button.
						$("#save").click(function() {
							if (editrow >= 0) {
								var row = {
									alias : $("#alias").val(),
									nombre : $("#nombre").val(),
									apellido : $("#apellido").val(),
									email : $("#email").val()
								};
								var rowID = $('#usuarios').jqxGrid('getrowid', editrow);
								$('#usuarios').jqxGrid('updaterow', rowID, row);
							}
							$("#editionPopup").modal('hide');
						});

						// Hide popup when cancel
						$("#cancel").click(function() {
							$("#editionPopup").modal('hide');
						});

						// Configuracion del control de ingreso del precio
						$("#precio").inputmask("currency", {
							"autoUnmask" : true
						});
						$("#costo").inputmask("currency", {
							"autoUnmask" : true
						});
					});
		</script>
	</div>
</body>
<script type="text/javascript" src="../../../resources/bootstrap/js/bootstrap.js" th:src="@{/resources/bootstrap/js/bootstrap.js}" />
</html>
