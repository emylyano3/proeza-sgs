<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Sistema de GestiÃ³n de Stock" />
	<meta name="author" content="Emiliano Schiano di Cola" />

	<div th:replace ="fragment/misc.html::appTitle"></div>
	<div th:replace ="fragment/misc.html::appIcon"></div>

	<link href="../../../resources/bootstrap/css/bootstrap.css" th:href="@{/resources/bootstrap/css/bootstrap.css}" rel="stylesheet" />
	<link href="../../../resources/metismenu/css/metisMenu.css" th:href="@{/resources/metismenu/css/metisMenu.css}" rel="stylesheet" />
	<link href="../../../resources/app/css/timeline.css" th:href="@{/resources/app/css/timeline.css}" rel="stylesheet" />
	<link href="../../../resources/animate/css/animate.css" th:href="@{/resources/animate/css/animate.css}" rel="stylesheet" />
	<link href="../../../resources/app/css/proeza-sgs.css" th:href="@{/resources/app/css/proeza-sgs.css}" rel="stylesheet" />
	<link href="../../../resources/font-awesome/css/font-awesome.css" th:href="@{/resources/font-awesome/css/font-awesome.css}" rel="stylesheet" type="text/css" />
	<link href="../../../resources/gallery/css/blueimp-gallery.css" th:href="@{/resources/gallery/css/blueimp-gallery.css}" rel="stylesheet" />
	<link href="../../../resources/gallery/css/blueimp-gallery-indicator.css" th:href="@{/resources/gallery/css/blueimp-gallery-indicator.css}" rel="stylesheet" />
</head>

<body>
    <div th:replace="fragment/misc.html::splash"></div>
    <div th:replace="fragment/bar.html::header"></div>
    <div th:replace="fragment/menu.html::mainMenuLeft" ></div>
	<div th:replace="fragment/misc.html::loadImagePopup"></div>
	
	<div id="wrapper">
		<div class="content small-header">
			<div th:replace="fragment/misc.html::pageTitle"></div>
			<div id="content" >
				<link rel="stylesheet" href="../../../resources/jqx/css/jqx.base.css" th:href="@{/resources/jqx/css/jqx.base.css}" type="text/css" media="screen" />
				<link rel="stylesheet" href="../../../resources/jqx/css/jqx.energyblueproeza.css" th:href="@{/resources/jqx/css/jqx.energyblueproeza.css}" type="text/css" media="screen" />
		        <link rel="stylesheet" href="../../../resources/fileinput/css/fileinput.css" th:href="@{/resources/fileinput/css/fileinput.css}" media="all" type="text/css" />
				<!-- Grilla de usuarios -->
				<div id="gridPanel" class="row animated zoomIn">
					<div class="col-md-12">
						<div id="gridUsuarios" />
					</div> 
				</div>
		         <div id="editionPanel" class="hpanel animated zoomIn" hidden="true">
		            <div class="panel-heading">
		                <span id="formTitle" />
		            </div>
		            <div class="panel-body">
		        		<form id="userForm" class="form-horizontal" >
		            		<div class="row">
		            			<div class="col-md-6">                           
		        					<div class="form-group">
		        						<label for="alias" class="col-sm-2 control-label" th:text="#{control.username}" />
		        						<div class="col-sm-10">
		        							<input id="alias" class="form-control input-md" required="required" />
		        						</div>
		        					</div>
		        					<div class="form-group">
		        						<label for="nombre" class="col-sm-2 control-label" th:text="#{control.name}" />
		        						<div class="col-sm-10">
		        							<input id="nombre" class="form-control input-md" required="required" />
		        						</div>
		        					</div>
		        					<div class="form-group">
		        						<label for="apellido" class="col-sm-2 control-label" th:text="#{control.lastname}" />
		        						<div class="col-sm-10">
		        							<input id="apellido" class="form-control input-md" required="required" />
		        						</div>
		        					</div>
		        					<div class="form-group">
		        						<label for="email" class="col-sm-2 control-label" th:text="#{control.email}" />
		        						<div class="col-sm-10">
		        							<input id="email" type="email" class="form-control input-md" required="required" />
		        						</div>
		            				</div>
		        					<div id="passwordGroup" class="form-group" >
		        						<label for="password" class="col-sm-2 control-label" th:text="#{control.password}" />
		        						<div class="col-sm-10">
		                                    <div class="input-group">
		            							<input id="password" class="form-control input-md" disabled="disabled" />
		                                        <span class="input-group-btn">
		                                            <button id="btnGenerate" class="btn btn-default" th:text="#{control.generatepass}" type="button" />
		                                        </span>
		            						</div>
		                                </div>
		            				</div>
		        					<div class="form-group">
		        						<label for="roles" class="col-sm-2 control-label" th:text="#{control.roles}" />
		        						<div class="col-sm-10">
		                                    <select id="roles" class="form-control input-md" multiple="multiple" required="required" >
		                                        <option th:each="role : ${roles}" th:text="${role.nombre}" th:value="${role.codigo}" />
		                                    </select>
		        						</div>
		            				</div>
		                            <p/>
		                            <p/>
		                            <button id="cancel" type="button" class="btn btn-default" th:text="#{control.cancel}" />
		                            <button id="save" type="submit" class="btn btn-primary" th:text="#{control.save}" />
		            			</div>
		            		</div>
		        		</form>
		            </div>
		            <div class="panel-footer">
		                <span id="formFooter" />
		            </div>
		        </div>
		       
				<!-- Menu Contextual -->
				<div id="gridMenu">
			        <ul>
			            <li id="editUsu" th:text="#{user.admin.menu.edit}"/>
			            <li id="deleteUsu" th:text="#{user.admin.menu.remove}"/>
			            <li id="newUsu" th:text="#{user.admin.menu.create}"/>
			            <li id="setPhoto" th:text="#{user.admin.menu.setPhoto}"/>
			        </ul>
		       </div>
		        <div id="commandBar" class="floating">
		            <button id="newUser" class="btn fa fa-plus fa-3x btn-plus" th:title="#{user.add.tooltip}"/>
		        </div>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../../../resources/jquery/jquery.js" th:src="@{/resources/jquery/jquery.js}" ></script>
    <script type="text/javascript" src="../../../resources/bootstrap/js/bootstrap.js" th:src="@{/resources/bootstrap/js/bootstrap.js}" ></script>
	<script type="text/javascript" src="../../../resources/metismenu/js/metisMenu.js" th:src="@{/resources/metismenu/js/metisMenu.js}" ></script>
    <script type="text/javascript" src="../../../resources/sparkline/js/sparkline.js" th:src="@{/resources/sparkline/js/sparkline.js}"></script>
    <script type="text/javascript" src="../../../resources/icheck/icheck.js" th:src="@{/resources/icheck/icheck.js}"></script>
	<script type="text/javascript" src="../../../resources/app/js/proeza-sgs.js" th:src="@{/resources/app/js/proeza-sgs.js}" ></script>
    <script type="text/javascript" src="../../../resources/app/js/menu.js" th:src="@{/resources/app/js/menu.js}"></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxcore.js" th:src="@{/resources/jqx/js/jqxcore.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxdata.js" th:src="@{/resources/jqx/js/jqxdata.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxbuttons.js" th:src="@{/resources/jqx/js/jqxbuttons.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxscrollbar.js" th:src="@{/resources/jqx/js/jqxscrollbar.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxmenu.js" th:src="@{/resources/jqx/js/jqxmenu.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.js" th:src="@{/resources/jqx/js/jqxgrid.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.selection.js" th:src="@{/resources/jqx/js/jqxgrid.selection.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxnumberinput.js" th:src="@{/resources/jqx/js/jqxnumberinput.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxwindow.js" th:src="@{/resources/jqx/js/jqxwindow.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxlistbox.js" th:src="@{/resources/jqx/js/jqxlistbox.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxdropdownlist.js" th:src="@{/resources/jqx/js/jqxdropdownlist.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxinput.js" th:src="@{/resources/jqx/js/jqxinput.js}" ></script>
	<script type="text/javascript" src="../../../resources/jqx/js/jqxgrid.sort.js" th:src="@{/resources/jqx/js/jqxgrid.sort.js}" ></script>
	<script type="text/javascript" src="../../../resources/jquery/jquery.inputmask.bundle.js" th:src="@{/resources/jquery/jquery.inputmask.bundle.js}" ></script>
	<script type="text/javascript" src="../../../resources/bootstrap/js/bootstrap-notify.js" th:src="@{/resources/bootstrap/js/bootstrap-notify.js}" ></script>
	<script type="text/javascript" src="../../../resources/fileinput/js/fileinput.js" th:src="@{/resources/fileinput/js/fileinput.js}" ></script>
	<script type="text/javascript" src="../../../resources/fileinput/js/fileinput_locale_es.js" th:src="@{/resources/fileinput/js/fileinput_locale_es.js}" ></script>
	<script type="text/javascript" src="../../../resources/password/js/pGenerator.jquery.js" th:src="@{/resources/password/js/pGenerator.jquery.js}" ></script>
	<script type="text/javascript" src="../../../resources/app/js/usuario.js" th:src="@{/resources/app/js/usuario.js}"></script>
	<script th:inline="javascript">
	 	/*<![CDATA[*/
		// Inicializacion de la tabla de usuarios
		var formMode;
		var currentrow = -1;
		$(document).ready(function() {
			loadUserSalesSparkline($("#userAlias").text(), 12, 7);
			// prepare the data
			var source = {
				datatype : 'json',
				id : 'id',
				url : usuario.rest.findAll,
				dataFields: [
	                    { name: 'alias', type: 'string' },
	                    { name: 'nombre', type: 'string' },
	                    { name: 'apellido', type: 'string' },
	                    { name: 'email', type: 'string' }
	     	    ]
			};
			
			var dataAdapter = new $.jqx.dataAdapter(source);
			// initializa la grilla de usuarios
			$('#gridUsuarios').jqxGrid({
				width : '100%',
				theme : 'energyblueproeza',
				source : dataAdapter,
				pageable : false,
				autoheight : false,
				altrows : true,
				sortable : true,
				enabletooltips : true,
				columns : [ {
					text : /*[[#{user.grid.alias}]]*/ 'Alias',
					dataField : 'alias',
					width : '20%'
				}, {
					text : /*[[#{user.grid.name}]]*/ 'Nombre',
					dataField : 'nombre',
					width : '25%'
				}, {
					text : /*[[#{user.grid.surname}]]*/ 'Apellido',
					dataField : 'apellido',
					width : '25%'
				}, {
					text : /*[[#{user.grid.email}]]*/ 'E-mail',
					dataField : 'email',
					width : '30%'
				} ]
			});
			// create context menu
			var contextMenu = $('#gridMenu').jqxMenu({
				width : 180,
				autoOpenPopup : false,
				mode : 'popup'

			});
			$('#gridUsuarios').on('contextmenu', function() {
				return false;
			});
			$('#newUser').click(function(){
				initCreationForm();
			});
			// handle context menu clicks.
			$('#gridMenu').on('itemclick', function(event) {
				var args = event.args;
				currentrow = $('#gridUsuarios').jqxGrid('getselectedrowindex');// open the popup window when the user clicks a button.
				var offset = $('#gridUsuarios').offset();
				// get the clicked row's data and initialize the input fields.
				if ($.trim($(args).text()) == [[#{user.admin.menu.edit}]]) {
					initEditionForm();
				} else if ($.trim($(args).text()) == [[#{user.admin.menu.remove}]]) {
					deleteUser();
				} else if ($.trim($(args).text()) == [[#{user.admin.menu.create}]]) {
					initCreationForm();
				} else if ($.trim($(args).text()) == [[#{user.admin.menu.setPhoto}]]) {
					openBrowseImageDialog();
				}
			});
			$('#gridUsuarios').on(
				'rowclick',
				function(event) {	
					if (event.args.rightclick) {	
						$('#gridUsuarios').jqxGrid('selectrow', event.args.rowindex);
						var scrollTop = $(window).scrollTop();
						var scrollLeft = $(window).scrollLeft();
						contextMenu.jqxMenu(
							'open', 
							parseInt(event.args.originalEvent.clientX) + 5 + scrollLeft,
							parseInt(event.args.originalEvent.clientY) + 5 + scrollTop
						);
						return false;
					}
				}
			);
		    
			$('#userForm').submit(function( e ) {
   			    e.preventDefault();
   			    var formData = {};
   			    // Reuno la data del formulario y elimino los "undefined" 
   			    $.each(this, function(i, v) {
   			        var input = $(v);
   			        var itemId = input.attr('id');
  			        	formData[itemId] = input.val();
   			        delete formData['undefined'];
   			    });
   			    switch (formMode) {
				case 'creation' :
					addUser(formData);
					break;
				case 'edition' :
  	 					updateUser(formData);
					break;
				default:
					break;
				}
		        return false; 
			});
			
			// Hide popup when cancel
			$('#cancel').click(function() {
				hideForm();
			});

			// Configuracion del control de ingreso del precio
			$('#precio').inputmask('currency', {
				'autoUnmask' : true
			});
			$('#costo').inputmask('currency', {
				'autoUnmask' : true
			});
            $('#eraser').click(function () {
                $('#gridUsuarios').jqxGrid('clear');
            });
            $('#btnGenerate').pGenerator({
                'bind': 'click',
                'passwordElement': null,
                'displayElement': $('#password'),
                'passwordLength': 8,
                'uppercase': true,
                'lowercase': true,
                'numbers':   true,
                'specialChars': false,
                'onPasswordGenerated': function (pwd) {} 
            });
		});

		function showForm () {
			$('#editionPanel').show();
			$('#commandBar').hide();
			$('#gridPanel').hide();	
		}

		function hideForm () {
			$('#editionPanel').hide();
			$('#commandBar').show();
			$('#gridPanel').show();	
		}
		
		function openBrowseImageDialog() {
			var dataRecord = $('#gridUsuarios').jqxGrid('getrowdata', currentrow);
			var fileInputOptions = {
				language: /*[[#{app.lnguage}]]*/ 'es',
				showUpload : true,
				showRemove : true,
        	    uploadAsync: true,
				maxFileCount : 1,
                allowedFileExtensions : ['jpg', 'png'],
				allowedFileTypes : ['image'],
                uploadUrl: usuario.rest.setPhoto + '?alias=' + dataRecord.alias
			};
         	// File input plugin options
            $('#uploadImage').fileinput(fileInputOptions);
			$('#addImagePopup').modal('show');
		}
		
		function initCreationForm () {
			formMode = 'creation';
			$('#alias').prop('disabled', false);
			$('#alias').val('');
			$('#nombre').val('');
			$('#apellido').val('');
			$('#password').val('');
			$('#btnGenerate').trigger('click');
			$('#email').val('');
			$('#formTitle').text([[#{user.admin.creation.title}]]);
			$('#formFooter').text([[#{user.admin.creating}]]);
			$('#roles').val([]);
			showForm();
		}
		
		function initEditionForm () {
			var dataRecord = $('#gridUsuarios').jqxGrid('getrowdata', currentrow);
			formMode = 'edition';
			findUser(dataRecord.alias);
			$('#alias').prop('disabled', true);
			$('#alias').val(dataRecord.alias);
			$('#nombre').val(dataRecord.nombre);
			$('#apellido').val(dataRecord.apellido);
			$('#email').val(dataRecord.email);
			$('#password').val('');
			$('#formTitle').text([[#{user.admin.edition.title}]]);
			$('#formFooter').text([[#{user.admin.editing}]] + dataRecord.nombre + ' ' + dataRecord.apellido);
			showForm();
		}
		
		function addUser (formData) {
			$.ajax({
	        	contentType : 'application/json; charset=utf-8',
				type : 'POST',
				url : usuario.rest.create,
				dataType: 'json',
				data : JSON.stringify(formData),
				success : function() {
					$.notify({
						title: [[#{user.create.success.title}]],
						message: [[#{user.create.success.message}]]
					},{
						type: 'success'
					});
					$('#gridUsuarios').jqxGrid('addrow', null, getRowData(), 0);
				},
				error: function () {            
					$.notify({
						title: [[#{user.create.error.title}]],
						message: [[#{user.create.error.message}]]
					},{
						type: 'danger'
					});
		        }
			});
			hideForm();
		}
		
		function updateUser (formData) {
			$.ajax({
				type : 'POST',
				url : usuario.rest.update,
				dataType: 'json',
				contentType: 'application/json',
				data : JSON.stringify(formData),
				success : function() {
					$.notify({
						title: [[#{user.update.success.title}]],
						message: [[#{user.update.success.message}]]
					},{
						type: 'success'
					});
					if (currentrow >= 0) {
   						var rowid = $('#gridUsuarios').jqxGrid('getrowid', currentrow);
  							$('#gridUsuarios').jqxGrid('updaterow', rowid, getRowData());
   					}
				},
				error: function () {
					$.notify({
						title: [[#{user.update.error.title}]],
						message: [[#{user.update.error.message}]]
					},{
						type: 'danger'
					});
		        }
			});
			hideForm();
		}
		
		function getRowData () {
		    return {
				alias : $('#alias').val(),
				nombre : $('#nombre').val(),
				apellido : $('#apellido').val(),
				email : $('#email').val()
			};
		}
	
		function deleteUser () {
			var dataRecord = $('#gridUsuarios').jqxGrid('getrowdata', currentrow);
			$.ajax({
				type : 'POST',
				url : usuario.rest.remove + '/' + dataRecord.alias,
				dataType: 'json',
				contentType: 'application/json',
				success : function() {
					$.notify({
						title: [[#{user.remove.success.title}]],
						message: [[#{user.remove.success.message}]]
					},{
						type: 'success'
					});
					if (currentrow >= 0) {
   						var rowid = $('#gridUsuarios').jqxGrid('getrowid', currentrow);
   						$('#gridUsuarios').jqxGrid('deleterow', rowid);
					}
				},
				error: function () {
					$.notify({
						title: [[#{user.remove.error.title}]],
						message: [[#{user.remove.error.message}]]
					},{
						type: 'danger'
					});
		        }
			});
		}
		
		function findUser (alias) {
			$.ajax({
				url : usuario.rest.find + '/' + alias,
				type : 'POST',
				dataType: 'json',
				contentType : 'application/json',
				success : function (data, status, jqXHR) {
					$('#roles').val(data.roles);
				},
				error: function (jqXHR, status) {
					$.notify({
						title: [[#{user.find.error.title}]],
						message: [[#{user.find.error.message}]] + alias
					},{
						type: 'danger'
					});
				}
			});
		}
		/*]]>*/
	</script>
</body>
</html>